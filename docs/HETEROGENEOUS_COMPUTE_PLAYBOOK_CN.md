# 异构计算与 LLM 推理优化：工程手册（公开版）

> **定位**：本手册用于把“异构计算/系统级性能分析/软硬协同优化”的工作方法沉淀为**可交付的工程模板**。  
> **边界**：不包含任何私有权重、私有数据、厂商 NDA 内容；不做不可验证的性能承诺。对外只输出可复现实验、日志与证据包。

---

## 1. 目标问题（工程范围）

异构计算开发/性能优化在大模型推理侧通常围绕三件事展开：

- **硬件与拓扑**：CPU/NUMA/内存带宽、GPU/显存、PCIe/NVLink、网络与存储的瓶颈画像。
- **框架与算子**：推理框架执行图、热点算子、Kernel 融合、编译与调度策略。
- **场景化约束**：吞吐/时延/显存/稳定性/成本之间的约束变换；针对不同业务场景快速给出可落地方案。

---

## 2. 交付物定义（面向业务与团队协作）

一份可落地的“性能优化交付”通常应包含：

- **性能口径**：指标定义、采样窗口、容差、对比基线（baseline）、回归门禁（gate）。
- **复现脚本**：一键跑通的测量脚本与环境指纹（env）。
- **问题定位记录**：profiling 证据、瓶颈结论、验证实验与反证实验（ablation）。
- **改动与回滚策略**：改动点、影响面评估、回滚条件、事故预案。

> 在本仓库中，以上交付物的最小化形态对应 `env/results/report/manifest` 证据包结构（见 `REPRODUCE.md` 与 `AUDIT.md`）。

---

## 3. 分析路径（从系统到算子）

### 3.1 系统层（System Level）

系统层分析聚焦于识别硬件资源瓶颈，通过以下维度定位性能限制：

- **CPU/内存瓶颈分析**：线程并发是否受限于内存带宽？NUMA/页面迁移对延迟的影响评估
- **GPU/显存资源评估**：显存容量对KV Cache、激活值、临时buffer的限制分析，显存带宽压力测试
- **互联拓扑验证**：多卡通信瓶颈定位（PCIe/NVLink拓扑优化、跨NUMA访问效率）
- **网络/存储瓶颈诊断**：模型加载、分布式权重拉取、checkpoint映射的冷启动延迟分析

**核心分析产出**：
- **硬件拓扑摘要**：CPU sockets/NUMA nodes配置、GPU列表与互联关系、内存/PCIe布局架构
- **资源利用率曲线**：CPU利用率监控、GPU SM利用率分析、显存占用趋势、带宽/吞吐性能曲线
- **系统稳定性证据**：长时运行测试记录、崩溃次数统计、异常日志摘要与根因分析

### 3.2 框架层（Framework Level）

在定位到“框架/调度层问题”时，优先确认：

- **执行图与热点**：prefill/decode 分段开销、attention/MLP/采样的占比。
- **并行策略**：TP/PP/EP 的切分是否与硬件拓扑匹配？是否存在负载不均？
- **缓存策略**：KV Cache 管理（分页/复用/压缩）对显存与带宽的影响。

### 3.3 算子层（Kernel Level）

当热点聚焦到算子：

- **算子融合**：减少 kernel launch、减少中间张量落地。
- **数据布局**：对齐/连续性/访问模式；减少不必要的 transpose 与 layout conversion。
- **编译与调度**：编译选项、向量化、指令级优化；算子选择（通用 vs 专用 kernel）。

---

## 4. LLM 推理侧典型优化主题（工程视角）

> 说明：以下为工程主题清单与验证方法，不代表仓库对外声明已完成所有实现；对外声明以证据包为准。

### 4.1 KV Cache（显存/带宽核心）

- **问题形态**：decode 阶段显存占用与显存带宽压力主导整体性能。
- **验证方法**：不同 batch/seq 下显存曲线、decode tokens/s、OOM 边界。
- **常见策略**：缓存分页/复用、KV 压缩（量化/分块）、prefill/decode 解耦、异步拷贝与 overlap。

### 4.2 并行化（TP/EP/PP）

- **问题形态**：吞吐受通信或负载不均限制。
- **验证方法**：单卡 vs 多卡 scaling、通信占比、tail latency。
- **常见策略**：拓扑感知的并行切分、分层 pipeline、专家路由与通信优化（EP/DeepEP 类主题）。

### 4.3 Speculative Decoding（投机采样）

- **问题形态**：以额外 compute 换更高 decode throughput，但对模型/场景敏感。
- **验证方法**：accept rate、吞吐提升、尾延迟与质量边界（如有公开证据）。

### 4.4 量化（Quantization）

- **问题形态**：以精度/质量（若声明）换显存/带宽/吞吐。
- **验证方法**：同口径基线对比（速度/内存/稳定性），质量类声明必须有同口径公开证据。

### 4.5 框架使能（vLLM / sglang）

对“新硬件使能/优化”的公开可交付形态通常是：

- **Enablement Checklist**：编译链、依赖、算子路径、后端选择、回退策略。
- **Profiling Playbook**：从端到端 trace 到热点算子定位的步骤模板。
- **Regression Gate**：把优化结果固化为可复测门禁。

### 4.6 静态存储 / 动态计算分离（适配假设）

> 说明：本节描述一种常见的系统形态与可验证的工程假设，不构成交付承诺；任何结论以 PoC 证据包为准。

- **形态**：将“体积大、更新频率低”的静态知识/记忆块，与“对时延/稳定性敏感”的动态计算图分离。
- **工程含义**：
  - 静态侧：适合分片/分块、索引化管理、补丁化更新与回滚（以包级 `manifest` 与版本追溯验收）
  - 动态侧：适合更保守的压缩档位与更严格的回归门禁（以 TTFT/吞吐/峰值内存/稳定性验收）

可验证的 PoC 口径示例：

- **异构压缩策略**：静态侧采用更高压缩档位；动态侧采用更保守档位；分别输出证据包并用同口径门禁验收。
- **惰性物化（Lazy Materialization）**：按访问需要解码/加载块，验收 `load_time`、`peak_rss/peak_vram` 的可复现变化与稳定性边界。
- **补丁化更新**：以块级增量包分发与回滚，验收版本可追溯性与完整性校验一致性。

---

## 5. 仓库中的对应证据入口

- **推理优化工作流模板**：`examples/inference_profiling/`
- **系统性能微基准（C++/Python）**：`examples/system_perf_microbench/`
- **测量口径与边界**：`MEASURE.md`、`AUDIT.md`、`docs/PUBLIC_BOUNDARY.md`

---

## 6. 协作与验收口径（可选）

- **业务侧验收**：先对齐指标口径与场景约束（吞吐/时延/显存/稳定性/成本），再输出方案与回滚条件。
- **工程侧协作**：以“复现脚本 + 证据包 + 门禁”作为协作载体，减少不可复现问题与口径分歧。


